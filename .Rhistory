NET_PERM = sum(NET_PERM),
NET_TEMP = sum(NET_TEMP),
NET_RESIDENTIAL = sum(NET_RESIDENTIAL)) %>%
mutate(ZIPCODE = as.numeric(ZIPCODE))%>%
relocate(Year, Quarter, .before = ZIPCODE) %>%
distinct(ZIPCODE, .keep_all = TRUE) %>%
select(-YYYYMM, -Month, -division)
quarter_2021 <- quarter_2021 %>%
group_by(Quarter, ZIPCODE) %>%
mutate(NET_ZIP = sum(NET_ZIP),
NET_PERM = sum(NET_PERM),
NET_TEMP = sum(NET_TEMP),
NET_RESIDENTIAL = sum(NET_RESIDENTIAL)) %>%
mutate(ZIPCODE = as.numeric(ZIPCODE))%>%
relocate(Year, Quarter, .before = ZIPCODE) %>%
distinct(ZIPCODE, .keep_all = TRUE) %>%
select(-YYYYMM, -Month, -division)
#Join data frames of all years
list <- list(quarter_2018,quarter_2019,quarter_2020,quarter_2021)
do.call("rbind", list)
COA_quarterly_zip <- do.call("rbind", lapply(list, as.data.frame))
#Adjust type to be able to transpose
COA_quarterly_zip <- COA_quarterly_zip  %>%
mutate(NET_ZIP = as.numeric(NET_ZIP),
NET_PERM = as.numeric(NET_PERM),
NET_TEMP = as.numeric(NET_TEMP),
NET_RESIDENTIAL = as.numeric(NET_RESIDENTIAL),
#This is the zipcode padding to make standardize zipcode format so pivot_wider works
ZIPCODE = str_pad(ZIPCODE, 5, side = c("left"), pad = "0"),
Quarter = str_pad(Quarter, 2, side = c("left"), pad = "0"))
#Create new variable joining year and quarter
COA_quarterly_zip$YYYYQQ <- paste(COA_quarterly_zip$Year,COA_quarterly_zip$Quarter, sep= "")
COA_quarterly_zip <- COA_quarterly_zip  %>%
relocate(YYYYQQ, .before = ZIPCODE) %>%
select(-Year, -Quarter)
write.csv(COA_quarterly_zip, file.path(path, "check.csv"))
#Transposing for each variable and merging again
NET_ZIP <- COA_quarterly_zip %>%
select(ZIPCODE, CITY, STATE, YYYYQQ, NET_ZIP) %>%
pivot_wider(names_from = YYYYQQ, values_from = NET_ZIP, names_prefix = "NET_ZIP_")
NET_PERM <- COA_quarterly_zip %>%
select(ZIPCODE, CITY, STATE, YYYYQQ, NET_PERM) %>%
pivot_wider(names_from = YYYYQQ, values_from = NET_PERM, names_prefix = "NET_PERM_")
NET_TEMP <- COA_quarterly_zip %>%
select(ZIPCODE,CITY, STATE, YYYYQQ, NET_TEMP) %>%
pivot_wider(names_from = YYYYQQ, values_from = NET_TEMP, names_prefix = "NET_TEMP_")
NET_RES <- COA_quarterly_zip %>%
select(ZIPCODE,CITY, STATE,YYYYQQ, NET_RESIDENTIAL) %>%
pivot_wider(names_from = YYYYQQ, values_from = NET_RESIDENTIAL, names_prefix = "NET_RES_")
#Merging the short data sets to create one data file
COA_quarterly <- NET_ZIP %>%
full_join(NET_PERM, by = "ZIPCODE")%>%
full_join(NET_TEMP, by = "ZIPCODE")%>%
full_join(NET_RES, by = "ZIPCODE") %>%
distinct(ZIPCODE,.keep_all= TRUE) %>%
select(-CITY.y, -STATE.y, -CITY.x.x, -STATE.x.x,-CITY.y.y, -STATE.y.y,) %>%
rename(CITY = CITY.x) %>%
rename(STATE = STATE.x)
join <- COA_quarterly %>%
left_join(tract_join_quarters)
View(COA_quarterly)
View(COA_quarterly_zip)
tract_join_quarters <- total_addresses_quarters %>%
left_join(tract_crosswalk) %>%
rename(ZIPCODE = ZIP)
tract_join_quarters <- na.omit(tract_join_quarters)
join <- COA_quarterly %>%
left_join(tract_join_quarters)
join <- COA_quarterly %>%
left_join(tract_join_quarters) %>%
distinct(ZIPCODE,Year,Quarter,.keep_all= TRUE)
View(join)
join <- COA_quarterly %>%
full_join(tract_join_quarters, by = "ZIPCODE")
View(join)
View(tract_join_quarters)
tract_join_quarters <- total_addresses_quarters %>%
left_join(tract_crosswalk) %>%
rename(ZIPCODE = ZIP) %>%
select(-ams_bus,-ams_oth)
tract_join_quarters <- na.omit(tract_join_quarters)
View(tract_join_quarters)
tract_join_quarters <- na.omit(tract_join_quarters)
write.csv(tract_join_quarters, file.path(path, "check.csv"))
tract_join_quarters <- tract_join_quarters %>%
group_by(YYYYQQ, ZIPCODE) %>%
mutate(ams_res = sum(ams_res),
ams_total = sum(ams_total)) %>%
select(-geoid) %>%
relocate(ZIPCODE, .before = ams_res)
write.csv(tract_join_quarters, file.path(path, "check.csv"))
list4 <- list(vacancy_q1_2018,vacancy_q2_2018,vacancy_q3_2018,vacancy_q4_2018, vacancy_q1_2019,vacancy_q2_2019,vacancy_q3_2019,vacancy_q4_2019,vacancy_q1_2020,vacancy_q2_2020,vacancy_q3_2020,vacancy_q4_2020,vacancy_q1_2021,vacancy_q2_2021)
do.call("rbind", list4)
total_addresses_quarters <- do.call("rbind", lapply(list4, as.data.frame))
#Create new variable joining year and quarter
total_addresses_quarters <- total_addresses_quarters  %>%
mutate(Quarter = str_pad(Quarter, 2, side = c("left"), pad = "0"))
total_addresses_quarters$YYYYQQ <- paste(total_addresses_quarters$Year,total_addresses_quarters$Quarter, sep= "")
total_addresses_quarters <- total_addresses_quarters  %>%
relocate(YYYYQQ, .before = geoid) %>%
select(Year, -Quarter)
#Create new variable for total addresses by census tract
total_addresses_quarters$ams_total <- total_addresses_quarters$ams_res + total_addresses_quarters$ams_bus + total_addresses_quarters$ams_oth
#Crosswalk of zipcode and census tract data
#Read in crosswalk file
tract_crosswalk <- read_csv("../tract_zip_crosswalk.csv")
#Rename zipcode to match the original data
tract_crosswalk <- tract_crosswalk %>%
rename(geoid = TRACT) %>%
mutate(geoid = as.factor(geoid))%>%
select(-RES_RATIO, -BUS_RATIO, -OTH_RATIO, -TOT_RATIO)
#Left join the original year data to the census tract + zipcode crosswalk
tract_join_quarters <- total_addresses_quarters %>%
left_join(tract_crosswalk) %>%
rename(ZIPCODE = ZIP) %>%
select(-ams_bus,-ams_oth)
#Remove census tracts without matching zipcode in provided census crosswalk
tract_join_quarters <- na.omit(tract_join_quarters)
#Group by for zipcode and date to get the total of residences in a zipcode
tract_join_quarters <- tract_join_quarters %>%
group_by(YYYYQQ, ZIPCODE) %>%
mutate(ams_res = sum(ams_res),
ams_total = sum(ams_total)) %>%
select(-geoid) %>%
relocate(ZIPCODE, .before = ams_res)
library(foreign)
#Read in HUD vacancy data (in quarters)
#Key variable of interest: AMS_RES, total count of residential addresses; AMS_BUS, total count of businesses
#Note: Excluded q3 in 2021 because HUD data is incomplete
vacancy_q1_2018 <- read.dbf("../usps_vac_032018.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q1_2018$Year <- "2018"
vacancy_q1_2018$Quarter <- "1"
vacancy_q2_2018 <- read.dbf("../usps_vac_062018.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q2_2018$Year <- "2018"
vacancy_q2_2018$Quarter <- "2"
vacancy_q3_2018 <- read.dbf("../usps_vac_092018.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q3_2018$Year <- "2018"
vacancy_q3_2018$Quarter <- "3"
vacancy_q4_2018 <- read.dbf("../usps_vac_122018.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q4_2018$Year <- "2018"
vacancy_q4_2018$Quarter <- "4"
vacancy_q1_2019 <- read.dbf("../usps_vac_032019.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q1_2019$Year <- "2019"
vacancy_q1_2019$Quarter <- "1"
vacancy_q2_2019 <- read.dbf("../usps_vac_062019.dbf")%>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q2_2019$Year <- "2019"
vacancy_q2_2019$Quarter <- "2"
vacancy_q3_2019 <- read.dbf("../usps_vac_092019.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q3_2019$Year <- "2019"
vacancy_q3_2019$Quarter <- "3"
vacancy_q4_2019 <- read.dbf("../usps_vac_122019.dbf")%>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q4_2019$Year <- "2019"
vacancy_q4_2019$Quarter <- "4"
vacancy_q1_2020 <- read.dbf("../usps_vac_032020.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q1_2020$Year <- "2020"
vacancy_q1_2020$Quarter <- "1"
vacancy_q2_2020 <- read.dbf("../usps_vac_062020.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q2_2020$Year <- "2020"
vacancy_q2_2020$Quarter <- "2"
vacancy_q3_2020 <- read.dbf("../usps_vac_092020.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q3_2020$Year <- "2020"
vacancy_q3_2020$Quarter <- "3"
vacancy_q4_2020 <- read.dbf("../usps_vac_122020.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q4_2020$Year <- "2020"
vacancy_q4_2020$Quarter <- "4"
vacancy_q1_2021 <- read.dbf("../usps_vac_032021.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q1_2021$Year <- "2021"
vacancy_q1_2021$Quarter <- "1"
vacancy_q2_2021 <- read.dbf("../usps_vac_062021.dbf")%>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q2_2021$Year <- "2021"
vacancy_q2_2021$Quarter <- "2"
#Roll Up the quarterly data
list4 <- list(vacancy_q1_2018,vacancy_q2_2018,vacancy_q3_2018,vacancy_q4_2018, vacancy_q1_2019,vacancy_q2_2019,vacancy_q3_2019,vacancy_q4_2019,vacancy_q1_2020,vacancy_q2_2020,vacancy_q3_2020,vacancy_q4_2020,vacancy_q1_2021,vacancy_q2_2021)
do.call("rbind", list4)
total_addresses_quarters <- do.call("rbind", lapply(list4, as.data.frame))
#Create new variable joining year and quarter
total_addresses_quarters <- total_addresses_quarters  %>%
mutate(Quarter = str_pad(Quarter, 2, side = c("left"), pad = "0"))
total_addresses_quarters$YYYYQQ <- paste(total_addresses_quarters$Year,total_addresses_quarters$Quarter, sep= "")
total_addresses_quarters <- total_addresses_quarters  %>%
relocate(YYYYQQ, .before = geoid) %>%
select(Year, -Quarter)
#Create new variable for total addresses by census tract
total_addresses_quarters$ams_total <- total_addresses_quarters$ams_res + total_addresses_quarters$ams_bus + total_addresses_quarters$ams_oth
#Crosswalk of zipcode and census tract data
#Read in crosswalk file
tract_crosswalk <- read_csv("../tract_zip_crosswalk.csv")
#Rename zipcode to match the original data
tract_crosswalk <- tract_crosswalk %>%
rename(geoid = TRACT) %>%
mutate(geoid = as.factor(geoid))%>%
select(-RES_RATIO, -BUS_RATIO, -OTH_RATIO, -TOT_RATIO)
#Left join the original year data to the census tract + zipcode crosswalk
tract_join_quarters <- total_addresses_quarters %>%
left_join(tract_crosswalk) %>%
rename(ZIPCODE = ZIP) %>%
select(-ams_bus,-ams_oth)
#Remove census tracts without matching zipcode in provided census crosswalk
tract_join_quarters <- na.omit(tract_join_quarters)
#Group by for zipcode and date to get the total of residences in a zipcode
tract_join_quarters <- tract_join_quarters %>%
group_by(YYYYQQ, ZIPCODE) %>%
mutate(ams_res = sum(ams_res),
ams_total = sum(ams_total)) %>%
select(-geoid) %>%
relocate(ZIPCODE, .before = ams_res)
library(foreign)
#Read in HUD vacancy data (in quarters)
#Key variable of interest: AMS_RES, total count of residential addresses; AMS_BUS, total count of businesses
#Note: Excluded q3 in 2021 because HUD data is incomplete
vacancy_q1_2018 <- read.dbf("../usps_vac_032018.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q1_2018$Year <- "2018"
vacancy_q1_2018$Quarter <- "1"
vacancy_q2_2018 <- read.dbf("../usps_vac_062018.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q2_2018$Year <- "2018"
vacancy_q2_2018$Quarter <- "2"
vacancy_q3_2018 <- read.dbf("../usps_vac_092018.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q3_2018$Year <- "2018"
vacancy_q3_2018$Quarter <- "3"
vacancy_q4_2018 <- read.dbf("../usps_vac_122018.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q4_2018$Year <- "2018"
vacancy_q4_2018$Quarter <- "4"
vacancy_q1_2019 <- read.dbf("../usps_vac_032019.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q1_2019$Year <- "2019"
vacancy_q1_2019$Quarter <- "1"
vacancy_q2_2019 <- read.dbf("../usps_vac_062019.dbf")%>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q2_2019$Year <- "2019"
vacancy_q2_2019$Quarter <- "2"
vacancy_q3_2019 <- read.dbf("../usps_vac_092019.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q3_2019$Year <- "2019"
vacancy_q3_2019$Quarter <- "3"
vacancy_q4_2019 <- read.dbf("../usps_vac_122019.dbf")%>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q4_2019$Year <- "2019"
vacancy_q4_2019$Quarter <- "4"
vacancy_q1_2020 <- read.dbf("../usps_vac_032020.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q1_2020$Year <- "2020"
vacancy_q1_2020$Quarter <- "1"
vacancy_q2_2020 <- read.dbf("../usps_vac_062020.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q2_2020$Year <- "2020"
vacancy_q2_2020$Quarter <- "2"
vacancy_q3_2020 <- read.dbf("../usps_vac_092020.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q3_2020$Year <- "2020"
vacancy_q3_2020$Quarter <- "3"
vacancy_q4_2020 <- read.dbf("../usps_vac_122020.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q4_2020$Year <- "2020"
vacancy_q4_2020$Quarter <- "4"
vacancy_q1_2021 <- read.dbf("../usps_vac_032021.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q1_2021$Year <- "2021"
vacancy_q1_2021$Quarter <- "1"
vacancy_q2_2021 <- read.dbf("../usps_vac_062021.dbf")%>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q2_2021$Year <- "2021"
vacancy_q2_2021$Quarter <- "2"
#Roll Up the quarterly data
list4 <- list(vacancy_q1_2018,vacancy_q2_2018,vacancy_q3_2018,vacancy_q4_2018, vacancy_q1_2019,vacancy_q2_2019,vacancy_q3_2019,vacancy_q4_2019,vacancy_q1_2020,vacancy_q2_2020,vacancy_q3_2020,vacancy_q4_2020,vacancy_q1_2021,vacancy_q2_2021)
do.call("rbind", list4)
total_addresses_quarters <- do.call("rbind", lapply(list4, as.data.frame))
#Create new variable joining year and quarter
total_addresses_quarters <- total_addresses_quarters  %>%
mutate(Quarter = str_pad(Quarter, 2, side = c("left"), pad = "0"))
total_addresses_quarters$YYYYQQ <- paste(total_addresses_quarters$Year,total_addresses_quarters$Quarter, sep= "")
total_addresses_quarters <- total_addresses_quarters  %>%
relocate(YYYYQQ, .before = geoid) %>%
select(-Quarter)
#Create new variable for total addresses by census tract
total_addresses_quarters$ams_total <- total_addresses_quarters$ams_res + total_addresses_quarters$ams_bus + total_addresses_quarters$ams_oth
#Crosswalk of zipcode and census tract data
#Read in crosswalk file
tract_crosswalk <- read_csv("../tract_zip_crosswalk.csv")
#Rename zipcode to match the original data
tract_crosswalk <- tract_crosswalk %>%
rename(geoid = TRACT) %>%
mutate(geoid = as.factor(geoid))%>%
select(-RES_RATIO, -BUS_RATIO, -OTH_RATIO, -TOT_RATIO)
#Left join the original year data to the census tract + zipcode crosswalk
tract_join_quarters <- total_addresses_quarters %>%
left_join(tract_crosswalk) %>%
rename(ZIPCODE = ZIP) %>%
select(-ams_bus,-ams_oth)
#Remove census tracts without matching zipcode in provided census crosswalk
tract_join_quarters <- na.omit(tract_join_quarters)
#Group by for zipcode and date to get the total of residences in a zipcode
tract_join_quarters <- tract_join_quarters %>%
group_by(YYYYQQ, ZIPCODE) %>%
mutate(ams_res = sum(ams_res),
ams_total = sum(ams_total)) %>%
select(-geoid) %>%
relocate(ZIPCODE, .before = ams_res)
View(tract_join_quarters)
tract_join_quarters <- tract_join_quarters %>%
group_by(YYYYQQ, ZIPCODE) %>%
mutate(ams_res = sum(ams_res),
ams_total = sum(ams_total)) %>%
select(-geoid) %>%
relocate(ZIPCODE, .before = ams_res) %>%
relocate(Year, .before = ams_res)
tract_join_quarters <- total_addresses_quarters %>%
left_join(tract_crosswalk) %>%
rename(ZIPCODE = ZIP) %>%
select(-ams_bus,-ams_oth)
#Remove census tracts without matching zipcode in provided census crosswalk
tract_join_quarters <- na.omit(tract_join_quarters)
#Group by for zipcode and date to get the total of residences in a zipcode
tract_join_quarters <- tract_join_quarters %>%
group_by(YYYYQQ, ZIPCODE) %>%
mutate(ams_res = sum(ams_res),
ams_total = sum(ams_total)) %>%
select(-geoid) %>%
relocate(ZIPCODE, .before = ams_res) %>%
relocate(Year, .before = ams_res)
library(foreign)
#Read in HUD vacancy data (in quarters)
#Key variable of interest: AMS_RES, total count of residential addresses; AMS_BUS, total count of businesses
#Note: Excluded q3 in 2021 because HUD data is incomplete
vacancy_q1_2018 <- read.dbf("../usps_vac_032018.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q1_2018$Year <- "2018"
vacancy_q1_2018$Quarter <- "1"
vacancy_q2_2018 <- read.dbf("../usps_vac_062018.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q2_2018$Year <- "2018"
vacancy_q2_2018$Quarter <- "2"
vacancy_q3_2018 <- read.dbf("../usps_vac_092018.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q3_2018$Year <- "2018"
vacancy_q3_2018$Quarter <- "3"
vacancy_q4_2018 <- read.dbf("../usps_vac_122018.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q4_2018$Year <- "2018"
vacancy_q4_2018$Quarter <- "4"
vacancy_q1_2019 <- read.dbf("../usps_vac_032019.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q1_2019$Year <- "2019"
vacancy_q1_2019$Quarter <- "1"
vacancy_q2_2019 <- read.dbf("../usps_vac_062019.dbf")%>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q2_2019$Year <- "2019"
vacancy_q2_2019$Quarter <- "2"
vacancy_q3_2019 <- read.dbf("../usps_vac_092019.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q3_2019$Year <- "2019"
vacancy_q3_2019$Quarter <- "3"
vacancy_q4_2019 <- read.dbf("../usps_vac_122019.dbf")%>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q4_2019$Year <- "2019"
vacancy_q4_2019$Quarter <- "4"
vacancy_q1_2020 <- read.dbf("../usps_vac_032020.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q1_2020$Year <- "2020"
vacancy_q1_2020$Quarter <- "1"
vacancy_q2_2020 <- read.dbf("../usps_vac_062020.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q2_2020$Year <- "2020"
vacancy_q2_2020$Quarter <- "2"
vacancy_q3_2020 <- read.dbf("../usps_vac_092020.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q3_2020$Year <- "2020"
vacancy_q3_2020$Quarter <- "3"
vacancy_q4_2020 <- read.dbf("../usps_vac_122020.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q4_2020$Year <- "2020"
vacancy_q4_2020$Quarter <- "4"
vacancy_q1_2021 <- read.dbf("../usps_vac_032021.dbf") %>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q1_2021$Year <- "2021"
vacancy_q1_2021$Quarter <- "1"
vacancy_q2_2021 <- read.dbf("../usps_vac_062021.dbf")%>%
select(geoid,ams_res, ams_bus,ams_oth)
vacancy_q2_2021$Year <- "2021"
vacancy_q2_2021$Quarter <- "2"
#Roll Up the quarterly data
list4 <- list(vacancy_q1_2018,vacancy_q2_2018,vacancy_q3_2018,vacancy_q4_2018, vacancy_q1_2019,vacancy_q2_2019,vacancy_q3_2019,vacancy_q4_2019,vacancy_q1_2020,vacancy_q2_2020,vacancy_q3_2020,vacancy_q4_2020,vacancy_q1_2021,vacancy_q2_2021)
do.call("rbind", list4)
total_addresses_quarters <- do.call("rbind", lapply(list4, as.data.frame))
#Create new variable joining year and quarter
total_addresses_quarters <- total_addresses_quarters  %>%
mutate(Quarter = str_pad(Quarter, 2, side = c("left"), pad = "0"))
total_addresses_quarters$YYYYQQ <- paste(total_addresses_quarters$Year,total_addresses_quarters$Quarter, sep= "")
total_addresses_quarters <- total_addresses_quarters  %>%
relocate(YYYYQQ, .before = geoid)
#Create new variable for total addresses by census tract
total_addresses_quarters$ams_total <- total_addresses_quarters$ams_res + total_addresses_quarters$ams_bus + total_addresses_quarters$ams_oth
#Crosswalk of zipcode and census tract data
#Read in crosswalk file
tract_crosswalk <- read_csv("../tract_zip_crosswalk.csv")
#Rename zipcode to match the original data
tract_crosswalk <- tract_crosswalk %>%
rename(geoid = TRACT) %>%
mutate(geoid = as.factor(geoid))%>%
select(-RES_RATIO, -BUS_RATIO, -OTH_RATIO, -TOT_RATIO)
#Left join the original year data to the census tract + zipcode crosswalk
tract_join_quarters <- total_addresses_quarters %>%
left_join(tract_crosswalk) %>%
rename(ZIPCODE = ZIP) %>%
select(-ams_bus,-ams_oth)
#Remove census tracts without matching zipcode in provided census crosswalk
tract_join_quarters <- na.omit(tract_join_quarters)
#Group by for zipcode and date to get the total of residences in a zipcode
tract_join_quarters <- tract_join_quarters %>%
group_by(YYYYQQ, ZIPCODE) %>%
mutate(ams_res = sum(ams_res),
ams_total = sum(ams_total)) %>%
select(-geoid) %>%
relocate(ZIPCODE, .before = ams_res) %>%
relocate(Year, .before = ams_res)%>%
relocate(Quarter, .before = ams_res)
View(tract_join_quarters)
View(tract_join_quarters)
View(tract_join_quarters)
addresses_in_zip <- tract_join_quarters %>%
filter(Quarter == "01")
View(addresses_in_zip)
write.csv(addresses_in_zip, file.path(path, "check.csv"))
write.csv(addresses_in_zip, file.path(path, "check.csv"))
addresses_in_zip <- tract_join_quarters %>%
filter(Quarter == "01")%>%
select(-Quarter, YYYYQQ)
ddresses_in_zip <- tract_join_quarters %>%
filter(Quarter == "01")%>%
select(-Quarter, -YYYYQQ)
addresses_in_zip <- tract_join_quarters %>%
filter(Quarter == "01") %>%
select(-Quarter, -YYYYQQ)
addresses_in_zip <- tract_join_quarters %>%
filter(Quarter == "01") %>%
select(-YYYYQQ, -Quarter)
addresses_in_zip <- tract_join_quarters %>%
filter(Quarter == "01") %>%
ungroup() %>%
select(-YYYYQQ, -Quarter)
addresses_in_zip <- tract_join_quarters %>%
filter(Quarter == "01") %>%
ungroup() %>%
select(-YYYYQQ, -Quarter, -USPS_ZIP_PREF_CITY, -USPS_ZIP_PREF_STATE)
res_denom <- addresses_in_zip %>%
pivot_wider(names_from = Year, values_from =ams_res, names_prefix = "total_res_")
res_denom <- addresses_in_zip %>%
group_by(ZIPCODE) %>%
pivot_wider(names_from = Year, values_from =ams_res, names_prefix = "total_res_")
View(res_denom)
write.csv(addresses_in_zip, file.path(path, "check.csv"))
write.csv(addresses_in_zip, file.path(path, "check.csv"))
res_denom <- addresses_in_zip %>%
group_by(ZIPCODE) %>%
pivot_wider(names_from = Year, values_from =ams_res, names_prefix = "total_res_")
View(res_denom)
View(COA_quarterly)
View(COA_quarterly_zip)
res_denom <- addresses_in_zip %>%
select(ZIPCODE, YEAR, ams_res) %>%
pivot_wider(names_from = Year, values_from =ams_res, names_prefix = "total_res_")
res_denom <- addresses_in_zip %>%
select(ZIPCODE, Year, ams_res) %>%
pivot_wider(names_from = Year, values_from =ams_res, names_prefix = "total_res_")
addresses_in_zip <- tract_join_quarters %>%
filter(Quarter == "01") %>%
ungroup() %>%
select(-YYYYQQ, -Quarter, -USPS_ZIP_PREF_CITY, -USPS_ZIP_PREF_STATE)
write.csv(addresses_in_zip, file.path(path, "check.csv"))
res_denom <- addresses_in_zip %>%
select(ZIPCODE, Year, ams_res) %>%
pivot_wider(names_from = Year, values_from =ams_res, names_prefix = "total_res_")
addresses_in_zip <- tract_join_quarters %>%
filter(Quarter == "01") %>%
ungroup() %>%
select(-YYYYQQ, -Quarter, -USPS_ZIP_PREF_CITY, -USPS_ZIP_PREF_STATE) %>%
distinct()
write.csv(addresses_in_zip, file.path(path, "check.csv"))
res_denom <- addresses_in_zip %>%
select(ZIPCODE, Year, ams_res) %>%
pivot_wider(names_from = Year, values_from =ams_res, names_prefix = "total_res_")
View(res_denom)
total_denom <- addresses_in_zip %>%
select(ZIPCODE, Year, ams_total) %>%
pivot_wider(names_from = Year, values_from =ams_total, names_prefix = "total_zip_")
all_denom <- res_denom %>%
full_join(total_denom, by = "ZIPCODE")
View(all_denom)
final <- all_denom %>%
full_join(COA_quarterly, by = "ZIPCODE")
View(final)
final <- COA_quarterly %>%
full_join(all_denom, by = "ZIPCODE")
View(final)
write.csv(final, file.path(path, "COA_quarters_opendatafile.csv"))
